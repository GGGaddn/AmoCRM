# AmoCRM

Данная версия библиотеки поддерживает OAuth авторизацию и использует адреса AmoCRM API v4. 

## Установка

```
npm install amocrm-js
```

## Что такое OAuth и как всё настроить?

Я снял для вас отдельное видео, ознакомьтесь с основами работы нового протокола и библиотеки: https://youtu.be/eK7xYAbxJHo

### Код авторизации известен

Его можно получить с помощью упрощенной авторизации или самостоятельно написанного обработчика 
адреса интеграции (redirectUri).

```js
const AmoCRM = require( 'amocrm-js' );

const crm = new AmoCRM({
    // логин пользователя в портале, где адрес портала domain.amocrm.ru
    domain: 'domain', // может быть указан полный домен вида domain.amocrm.ru, domain.amocrm.com
    /* 
      Информация об интеграции (подробности подключения 
      описаны на https://www.amocrm.ru/developers/content/oauth/step-by-step)
    */
    auth: {
      client_id: 'clientId', // ID интеграции
      client_secret: 'clientSecret', // Секретный ключ
      redirect_uri: 'redirectUri', // Ссылка для перенаправления
      code: 'code' // Код авторизации
    },
});
```

### Встроенный OAuth-сервер

В AmoCRM API у кода авторизации есть особенность: его можно использовать __только один раз__ для получения 
токена. Последующие запросы на получение токена будут выдавать ошибку.

Чтобы облегчить процесс получения токена, в данный пакет встроен OAuth-сервер, 
который может обрабатывать указанный адрес перенаправления.

Пример настройки без параметра *code*:

```js
const AmoCRM = require( 'amocrm-js' );

const crm = new AmoCRM({
    // логин пользователя в портале, где адрес портала domain.amocrm.ru
    domain: 'domain', // может быть указан полный домен вида domain.amocrm.ru, domain.amocrm.com
    /* 
      Информация об интеграции (подробности подключения 
      описаны на https://www.amocrm.ru/developers/content/oauth/step-by-step)
    */
    auth: {
      client_id: 'clientId', // ID интеграции
      client_secret: 'clientSecret', // Секретный ключ
      redirect_uri: 'redirectUri', // Ссылка для перенаправления,
      server: {
        // порт, на котором запустится сервер авторизации
        port: 3000
      }
    },
});
```

Как выглядит процесс авторизации:

1. Сервер ожидает перехода пользователя по адресу: *crm.connection.getAuthUrl(mode)*
2. При успешном переходе пользователь перенаправляется на {redirectUri}, заданный в интеграции
3. Сервер авторизации перехватывает запрос на {redirectUri} 
(как это сделать, описано ниже), извлекает код авторизации и
с помощью *crm.connection.setCode(code)* автоматически получает токен для работы

#### Использование в целях разработки

Один из простых способ разработки интеграции: библиотека-сервис [ngrok](https://ngrok.com).
Пакет перенаправляет трафик с вашего компьютера на заданный публичный IP, который можно задать в
адресе интеграции.

После установки пакета:

1. Выполните в терминале команду: ```ngrok http 3001```
2. Полученный в результат адрес вида https://  указываем в настройках интеграции AmoCRM
3. В настройках указываем номер порта (в нашем примере 3001) и полученный ngrok-адрес в {auth.redirect_uri}
4. Получаем адрес ссылке, по которой необходимо будет перейти через *crm.connection.getAuthUrl()*
5. Переходим по ссылке, после этого код автоматически установится и библиотека запросит новый токен

Пример настроек:

```js
const crm = new AmoCRM({
    // ...
    auth: {
      // ...
      redirect_uri: 'https://555555.ngrok.io',
      server: {
        port: 3001
      }
    },
});
```

